# name: Build Production

# on:
#     push:
#         branches:
#             - release
#     workflow_dispatch: # Allow manual triggering

# jobs:
#     build-ios-production:
#         name: Build iOS Production
#         runs-on: macos-14
#         timeout-minutes: 60

#         steps:
#             - name: Checkout code
#               uses: actions/checkout@v4

#             - name: Setup Node.js
#               uses: actions/setup-node@v4
#               with:
#                   node-version: '20'

#             - name: Setup pnpm
#               uses: pnpm/action-setup@v2
#               with:
#                   version: 10

#             - name: Get pnpm store directory
#               id: pnpm-cache
#               shell: bash
#               run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

#             - name: Setup pnpm cache
#               uses: actions/cache@v4
#               with:
#                   path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
#                   key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
#                   restore-keys: |
#                       ${{ runner.os }}-pnpm-store-

#             - name: Install dependencies
#               run: pnpm install --frozen-lockfile

#             - name: Setup Ruby
#               uses: ruby/setup-ruby@v1
#               with:
#                   working-directory: apps/mobile
#                   bundler-cache: true

#             - name: Install CocoaPods
#               run: |
#                   cd apps/mobile/ios
#                   bundle exec pod install

#             - name: Setup Match certificates
#               env:
#                   MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
#                   MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
#                   APPLE_ID: ${{ secrets.APPLE_ID }}
#                   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
#               run: |
#                   cd apps/mobile
#                   bundle exec fastlane match appstore --readonly

#             - name: Build iOS Production
#               env:
#                   MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
#                   MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
#                   APPLE_ID: ${{ secrets.APPLE_ID }}
#                   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
#                   PERA_MAINNET_BACKEND_URL: ${{ secrets.PRODUCTION_MAINNET_BACKEND_URL }}
#                   PERA_TESTNET_BACKEND_URL: ${{ secrets.PRODUCTION_TESTNET_BACKEND_URL }}
#                   PERA_BACKEND_API_KEY: ${{ secrets.PRODUCTION_BACKEND_API_KEY }}
#                   IOS_PRODUCTION_BUNDLE_ID: com.algorand.perarn
#               run: |
#                   cd apps/mobile
#                   bundle exec fastlane ios build_production

#             - name: Upload iOS artifact
#               uses: actions/upload-artifact@v4
#               with:
#                   name: ios-production-ipa
#                   path: build/ios/Mobile-Production.ipa
#                   retention-days: 90 # Keep production builds longer

#             - name: Deploy to TestFlight
#               if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
#               env:
#                   MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
#                   APPLE_ID: ${{ secrets.APPLE_ID }}
#                   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
#                   ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
#                   ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
#                   ASC_KEY: ${{ secrets.ASC_KEY }}
#               run: |
#                   cd apps/mobile
#                   bundle exec fastlane ios deploy_testflight scheme:Mobile-Production

#             - name: Create GitHub Release
#               if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
#               uses: softprops/action-gh-release@v1
#               with:
#                   files: |
#                       build/ios/Mobile-Production.ipa
#                   draft: true
#                   generate_release_notes: true

#     build-android-production:
#         name: Build Android Production
#         runs-on: ubuntu-latest
#         timeout-minutes: 45

#         steps:
#             - name: Checkout code
#               uses: actions/checkout@v4

#             - name: Setup Node.js
#               uses: actions/setup-node@v4
#               with:
#                   node-version: '20'

#             - name: Setup pnpm
#               uses: pnpm/action-setup@v2
#               with:
#                   version: 10

#             - name: Get pnpm store directory
#               id: pnpm-cache
#               shell: bash
#               run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

#             - name: Setup pnpm cache
#               uses: actions/cache@v4
#               with:
#                   path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
#                   key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
#                   restore-keys: |
#                       ${{ runner.os }}-pnpm-store-

#             - name: Install dependencies
#               run: pnpm install --frozen-lockfile

#             - name: Setup JDK 17
#               uses: actions/setup-java@v4
#               with:
#                   distribution: 'temurin'
#                   java-version: '17'

#             - name: Setup Gradle cache
#               uses: actions/cache@v4
#               with:
#                   path: |
#                       ~/.gradle/caches
#                       ~/.gradle/wrapper
#                   key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
#                   restore-keys: |
#                       ${{ runner.os }}-gradle-

#             - name: Decode Android keystore
#               env:
#                   ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
#               run: |
#                   echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > apps/mobile/android/app/release.keystore

#             - name: Create keystore.properties
#               env:
#                   ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
#                   ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
#                   ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
#               run: |
#                   cat > apps/mobile/android/keystore.properties << EOF
#                   storeFile=app/release.keystore
#                   storePassword=$ANDROID_KEYSTORE_PASSWORD
#                   keyAlias=$ANDROID_KEY_ALIAS
#                   keyPassword=$ANDROID_KEY_PASSWORD
#                   EOF

#             - name: Build Android Production APK
#               env:
#                   PERA_MAINNET_BACKEND_URL: ${{ secrets.PRODUCTION_MAINNET_BACKEND_URL }}
#                   PERA_TESTNET_BACKEND_URL: ${{ secrets.PRODUCTION_TESTNET_BACKEND_URL }}
#                   PERA_BACKEND_API_KEY: ${{ secrets.PRODUCTION_BACKEND_API_KEY }}
#               run: |
#                   cd apps/mobile/android
#                   ./gradlew assembleProductionRelease

#             - name: Upload Android APK
#               uses: actions/upload-artifact@v4
#               with:
#                   name: android-production-apk
#                   path: apps/mobile/android/app/build/outputs/apk/production/release/app-production-release.apk
#                   retention-days: 90

#             - name: Build Android Production AAB
#               env:
#                   PERA_MAINNET_BACKEND_URL: ${{ secrets.PRODUCTION_MAINNET_BACKEND_URL }}
#                   PERA_TESTNET_BACKEND_URL: ${{ secrets.PRODUCTION_TESTNET_BACKEND_URL }}
#                   PERA_BACKEND_API_KEY: ${{ secrets.PRODUCTION_BACKEND_API_KEY }}
#               run: |
#                   cd apps/mobile/android
#                   ./gradlew bundleProductionRelease

#             - name: Upload Android AAB
#               uses: actions/upload-artifact@v4
#               with:
#                   name: android-production-aab
#                   path: apps/mobile/android/app/build/outputs/bundle/productionRelease/app-production-release.aab
#                   retention-days: 90

#             - name: Deploy to Play Store Production Track
#               if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
#               env:
#                   PLAYSTORE_JSON_KEY: ${{ secrets.PLAYSTORE_JSON_KEY }}
#               run: |
#                   cd apps/mobile
#                   bundle exec fastlane android deploy_production

#             - name: Add to GitHub Release
#               if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
#               uses: softprops/action-gh-release@v1
#               with:
#                   files: |
#                       apps/mobile/android/app/build/outputs/apk/production/release/app-production-release.apk
#                       apps/mobile/android/app/build/outputs/bundle/productionRelease/app-production-release.aab
#                   draft: true
#                   generate_release_notes: true
