# name: Build Staging

# on:
#     push:
#         branches:
#             - main
#     workflow_dispatch: # Allow manual triggering

# jobs:
#     build-ios-staging:
#         name: Build iOS Staging
#         runs-on: macos-14 # Use latest macOS runner
#         timeout-minutes: 60

#         steps:
#             - name: Checkout code
#               uses: actions/checkout@v4

#             - name: Setup Node.js
#               uses: actions/setup-node@v4
#               with:
#                   node-version: '20'

#             - name: Setup pnpm
#               uses: pnpm/action-setup@v2
#               with:
#                   version: 10

#             - name: Get pnpm store directory
#               id: pnpm-cache
#               shell: bash
#               run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

#             - name: Setup pnpm cache
#               uses: actions/cache@v4
#               with:
#                   path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
#                   key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
#                   restore-keys: |
#                       ${{ runner.os }}-pnpm-store-

#             - name: Install dependencies
#               run: pnpm install --frozen-lockfile

#             - name: Setup Ruby
#               uses: ruby/setup-ruby@v1
#               with:
#                   working-directory: apps/mobile
#                   bundler-cache: true # Automatically installs gems

#             - name: Install CocoaPods
#               run: |
#                   cd apps/mobile/ios
#                   bundle exec pod install

#             - name: Setup Match certificates
#               env:
#                   MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
#                   MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
#                   APPLE_ID: ${{ secrets.APPLE_ID }}
#                   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
#               run: |
#                   cd apps/mobile
#                   bundle exec fastlane match appstore --readonly

#             - name: Build iOS Staging
#               env:
#                   MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
#                   MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
#                   APPLE_ID: ${{ secrets.APPLE_ID }}
#                   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
#                   PERA_MAINNET_BACKEND_URL: ${{ secrets.STAGING_MAINNET_BACKEND_URL }}
#                   PERA_TESTNET_BACKEND_URL: ${{ secrets.STAGING_TESTNET_BACKEND_URL }}
#                   PERA_BACKEND_API_KEY: ${{ secrets.STAGING_BACKEND_API_KEY }}
#                   IOS_STAGING_BUNDLE_ID: com.algorand.pera.staging
#               run: |
#                   cd apps/mobile
#                   bundle exec fastlane ios build_staging

#             - name: Upload iOS artifact
#               uses: actions/upload-artifact@v4
#               with:
#                   name: ios-staging-ipa
#                   path: build/ios/Mobile-Staging.ipa
#                   retention-days: 30

#             - name: Deploy to TestFlight (Optional)
#               if: github.ref == 'refs/heads/main'
#               env:
#                   MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
#                   APPLE_ID: ${{ secrets.APPLE_ID }}
#                   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
#                   ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
#                   ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
#                   ASC_KEY: ${{ secrets.ASC_KEY }}
#               run: |
#                   cd apps/mobile
#                   # Uncomment to enable automatic TestFlight upload
#                   # bundle exec fastlane ios deploy_testflight scheme:Mobile-Staging

#     build-android-staging:
#         name: Build Android Staging
#         runs-on: ubuntu-latest
#         timeout-minutes: 45

#         steps:
#             - name: Checkout code
#               uses: actions/checkout@v4

#             - name: Setup Node.js
#               uses: actions/setup-node@v4
#               with:
#                   node-version: '20'

#             - name: Setup pnpm
#               uses: pnpm/action-setup@v2
#               with:
#                   version: 10

#             - name: Get pnpm store directory
#               id: pnpm-cache
#               shell: bash
#               run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

#             - name: Setup pnpm cache
#               uses: actions/cache@v4
#               with:
#                   path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
#                   key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
#                   restore-keys: |
#                       ${{ runner.os }}-pnpm-store-

#             - name: Install dependencies
#               run: pnpm install --frozen-lockfile

#             - name: Setup JDK 17
#               uses: actions/setup-java@v4
#               with:
#                   distribution: 'temurin'
#                   java-version: '17'

#             - name: Setup Gradle cache
#               uses: actions/cache@v4
#               with:
#                   path: |
#                       ~/.gradle/caches
#                       ~/.gradle/wrapper
#                   key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
#                   restore-keys: |
#                       ${{ runner.os }}-gradle-

#             - name: Decode Android keystore
#               env:
#                   ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
#               run: |
#                   echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > apps/mobile/android/app/release.keystore

#             - name: Create keystore.properties
#               env:
#                   ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
#                   ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
#                   ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
#               run: |
#                   cat > apps/mobile/android/keystore.properties << EOF
#                   storeFile=app/release.keystore
#                   storePassword=$ANDROID_KEYSTORE_PASSWORD
#                   keyAlias=$ANDROID_KEY_ALIAS
#                   keyPassword=$ANDROID_KEY_PASSWORD
#                   EOF

#             - name: Build Android Staging
#               env:
#                   PERA_MAINNET_BACKEND_URL: ${{ secrets.STAGING_MAINNET_BACKEND_URL }}
#                   PERA_TESTNET_BACKEND_URL: ${{ secrets.STAGING_TESTNET_BACKEND_URL }}
#                   PERA_BACKEND_API_KEY: ${{ secrets.STAGING_BACKEND_API_KEY }}
#               run: |
#                   cd apps/mobile/android
#                   ./gradlew assembleStagingRelease

#             - name: Upload Android APK
#               uses: actions/upload-artifact@v4
#               with:
#                   name: android-staging-apk
#                   path: apps/mobile/android/app/build/outputs/apk/staging/release/app-staging-release.apk
#                   retention-days: 30

#             - name: Build Android AAB
#               env:
#                   PERA_MAINNET_BACKEND_URL: ${{ secrets.STAGING_MAINNET_BACKEND_URL }}
#                   PERA_TESTNET_BACKEND_URL: ${{ secrets.STAGING_TESTNET_BACKEND_URL }}
#                   PERA_BACKEND_API_KEY: ${{ secrets.STAGING_BACKEND_API_KEY }}
#               run: |
#                   cd apps/mobile/android
#                   ./gradlew bundleStagingRelease

#             - name: Upload Android AAB
#               uses: actions/upload-artifact@v4
#               with:
#                   name: android-staging-aab
#                   path: apps/mobile/android/app/build/outputs/bundle/stagingRelease/app-staging-release.aab
#                   retention-days: 30

#             - name: Deploy to Play Store Internal Track (Optional)
#               if: github.ref == 'refs/heads/main'
#               env:
#                   PLAYSTORE_JSON_KEY: ${{ secrets.PLAYSTORE_JSON_KEY }}
#               run: |
#                   cd apps/mobile
#                   # Uncomment to enable automatic Play Store upload
#                   # bundle exec fastlane android deploy_internal
