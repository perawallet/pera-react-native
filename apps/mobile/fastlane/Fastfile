# Fastfile for Pera Wallet React Native App
#
# This Fastfile contains lanes for building iOS and Android versions
# of Pera Wallet across different environments (dev, staging, production)

# Helper to get version from package.json (strips suffixes like -alpha)
def get_package_version
  require 'json'
  package_data = JSON.parse(File.read("../package.json"))
  package_data["version"].split("-").first
end

default_platform(:ios)

# ============================================================================
# iOS Platform
# ============================================================================

platform :ios do
  before_all do
    if is_ci
      app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
        duration: 1200,
        in_house: false
      )
    end
  end

  desc "Build iOS Staging"
  lane :build_staging do
    build_ios(
      scheme: "Pera-Staging",
      configuration: "Release",
      export_method: "ad-hoc",
      clean: false
    )
  end

  desc "Build iOS Production"
  lane :build_production do
    build_ios(
      scheme: "Pera-Production",
      configuration: "Release",
      export_method: "app-store"
    )
  end

  desc "Build iOS for specific scheme"
  private_lane :build_ios do |options|
    clean = options[:clean]
    clean = true if clean.nil?

    # Inject version from package.json
    version = get_package_version
    increment_version_number(
      version_number: version,
      xcodeproj: "./ios/pera.xcodeproj"
    )

    # Determine Bundle ID for export options
    bundle_id = case options[:scheme]
    when "Pera-Production" then "com.algorandllc.perarn"
    else "com.algorandllc.perarn.staging"
    end

    export_options = {}
    if ENV["IOS_PROFILE_NAME"]
      export_options[:provisioningProfiles] = {
        bundle_id => ENV["IOS_PROFILE_NAME"]
      }
    end

    gym(
      scheme: options[:scheme],
      configuration: options[:configuration],
      export_method: options[:export_method],
      workspace: "./ios/pera.xcworkspace",
      output_directory: "./build/ios",
      output_name: "#{options[:scheme]}.ipa",
      clean: clean,
      export_options: export_options
    )
  end


  desc "Deploy to TestFlight"
  lane :deploy_testflight do |options|
    scheme = options[:scheme] || "Pera-Staging"

    # Map scheme to configuration
    configuration = case scheme
    when "Pera-Staging" then "Staging"
    when "Pera-Production" then "Production"
    when "Pera-Dev" then "Dev"
    else "Staging"
    end

    if ENV['BUILD_NUMBER']
      increment_build_number(
        build_number: ENV['BUILD_NUMBER'],
        xcodeproj: "./ios/pera.xcodeproj"
      )
    end

    clean = options[:clean]
    clean = true if clean.nil?

    build_ios(
      scheme: scheme,
      configuration: configuration,
      export_method: "app-store",
      clean: clean
    )

      upload_to_testflight(
        skip_waiting_for_build_processing: true,
        ipa: "./build/ios/#{scheme}.ipa"
      )
  end

  desc "Increment build number"
  lane :bump_build do
    increment_build_number(
      xcodeproj: "./ios/pera.xcodeproj"
    )
  end

  desc "Increment version number"
  lane :bump_version do |options|
    increment_version_number(
      xcodeproj: "./ios/pera.xcodeproj",
      bump_type: options[:bump_type] || "patch"
    )
  end
end

# ============================================================================
# Android Platform
# ============================================================================

platform :android do
  desc "Build Android Staging"
  lane :build_staging do
    build_android(
      flavor: "staging",
      build_type: "Release"
    )
  end

  desc "Build Android Production"
  lane :build_production do
    build_android(
      flavor: "production",
      build_type: "Release"
    )
  end

  desc "Build Android for specific flavor and build type"
  private_lane :build_android do |options|
    clean = options[:clean]
    clean = true if clean.nil?
    
    # Inject version from package.json
    version = get_package_version
    increment_version_name(
      version_name: version,
      gradle_file_path: "android/app/build.gradle"
    )

    task = clean ? "clean bundle" : "bundle"

    gradle(
      task: task,
      flavor: options[:flavor],
      build_type: options[:build_type],
      project_dir: "android/",
      properties: {
        "android.injected.version.code" => ENV["BUILD_NUMBER"]
      }
    )
  end

  desc "Build and publish to Play Store Internal Track"
  lane :deploy_internal do |options|
    flavor = options[:flavor] || "staging"
    # Helper to convert flavor to camelCase for AAB path (e.g., production -> productionRelease)
    flavor_release = "#{flavor}Release"
    
    clean = options[:clean]
    clean = true if clean.nil?

    build_android(
      flavor: flavor,
      build_type: "Release",
      clean: clean
    )

    package_name = flavor == "production" ? "com.algorand.perarn" : "com.algorand.perarn.staging"

    upload_to_play_store(
      track: "internal",
      package_name: package_name,
      aab: "android/app/build/outputs/bundle/#{flavor_release}/app-#{flavor}-release.aab",
      version_code: ENV["BUILD_NUMBER"],
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key: "android/api-key.json"
    )
  end

  desc "Increment version code"
  lane :bump_version_code do
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )
  end

  desc "Increment version name"
  lane :bump_version_name do |options|
    increment_version_name(
      gradle_file_path: "android/app/build.gradle",
      bump_type: options[:bump_type] || "patch"
    )
  end
end

# ============================================================================
# Helper Functions
# ============================================================================

# Check if running in CI environment
def is_ci
  ENV['CI'] == 'true' || ENV['GITHUB_ACTIONS'] == 'true'
end
