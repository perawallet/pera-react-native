# Fastfile for Pera Wallet React Native App
#
# This Fastfile contains lanes for building iOS and Android versions
# of Pera Wallet across different environments (dev, staging, production)

default_platform(:ios)

# ============================================================================
# iOS Platform
# ============================================================================

platform :ios do
  desc "Build iOS Development"
  lane :build_dev do
    build_ios(
      scheme: "Pera-Dev",
      configuration: "Debug",
      export_method: "development"
    )
  end

  desc "Build iOS Staging"
  lane :build_staging do
    setup_match
    build_ios(
      scheme: "Pera-Staging",
      configuration: "Release",
      export_method: "ad-hoc"
    )
  end

  desc "Build iOS Production"
  lane :build_production do
    setup_match
    build_ios(
      scheme: "Pera-Production",
      configuration: "Release",
      export_method: "app-store"
    )
  end

  desc "Build iOS for specific scheme"
  private_lane :build_ios do |options|
    gym(
      scheme: options[:scheme],
      configuration: options[:configuration],
      export_method: options[:export_method],
      workspace: "apps/mobile/ios/pera.xcworkspace",
      output_directory: "./build/ios",
      output_name: "#{options[:scheme]}.ipa",
      clean: true,
      export_options: {
        provisioningProfiles: {
          ENV["IOS_DEV_BUNDLE_ID"] => "match Development #{ENV["IOS_DEV_BUNDLE_ID"]}",
          ENV["IOS_STAGING_BUNDLE_ID"] => "match AdHoc #{ENV["IOS_STAGING_BUNDLE_ID"]}",
          ENV["IOS_PRODUCTION_BUNDLE_ID"] => "match AppStore #{ENV["IOS_PRODUCTION_BUNDLE_ID"]}"
        }
      }
    )
  end

  desc "Setup code signing with Match"
  lane :setup_match do
    match(
      type: "appstore",
      readonly: is_ci,
      git_url: ENV["MATCH_GIT_URL"],
      app_identifier: [
        ENV["IOS_DEV_BUNDLE_ID"],
        ENV["IOS_STAGING_BUNDLE_ID"],
        ENV["IOS_PRODUCTION_BUNDLE_ID"]
      ]
    )
  end

  desc "Deploy to TestFlight"
  lane :deploy_testflight do |options|
    scheme = options[:scheme] || "Pera-Staging"

    if ENV['BUILD_NUMBER']
      increment_build_number(
        build_number: ENV['BUILD_NUMBER'],
        xcodeproj: "apps/mobile/ios/pera.xcodeproj"
      )
    end

    build_ios(
      scheme: scheme,
      configuration: "Release",
      export_method: "app-store"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      ipa: "./build/ios/#{scheme}.ipa"
    )
  end

  desc "Increment build number"
  lane :bump_build do
    increment_build_number(
      xcodeproj: "apps/mobile/ios/pera.xcodeproj"
    )
  end

  desc "Increment version number"
  lane :bump_version do |options|
    increment_version_number(
      xcodeproj: "apps/mobile/ios/pera.xcodeproj",
      bump_type: options[:bump_type] || "patch"
    )
  end
end

# ============================================================================
# Android Platform
# ============================================================================

platform :android do
  desc "Build Android Development"
  lane :build_dev do
    build_android(
      flavor: "dev",
      build_type: "Debug"
    )
  end

  desc "Build Android Staging"
  lane :build_staging do
    build_android(
      flavor: "staging",
      build_type: "Release"
    )
  end

  desc "Build Android Production"
  lane :build_production do
    build_android(
      flavor: "production",
      build_type: "Release"
    )
  end

  desc "Build Android for specific flavor and build type"
  private_lane :build_android do |options|
    gradle(
      task: "assemble",
      flavor: options[:flavor],
      build_type: options[:build_type],
      project_dir: "apps/mobile/android/",
      properties: {
        "android.injected.signing.store.file" => ENV["ANDROID_KEYSTORE_FILE"],
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      }
    )
  end

  desc "Build and publish to Play Store Internal Track"
  lane :deploy_internal do |options|
    flavor = options[:flavor] || "staging"
    # Helper to convert flavor to camelCase for AAB path (e.g., production -> productionRelease)
    flavor_release = "#{flavor}Release"
    
    build_android(
      flavor: flavor,
      build_type: "Release"
    )

    upload_to_play_store(
      track: "internal",
      aab: "apps/mobile/android/app/build/outputs/bundle/#{flavor_release}/app-#{flavor}-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Build and publish to Play Store Production Track"
  lane :deploy_production do
    build_android(
      flavor: "production",
      build_type: "Release"
    )

    upload_to_play_store(
      track: "production",
      aab: "apps/mobile/android/app/build/outputs/bundle/productionRelease/app-production-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Increment version code"
  lane :bump_version_code do
    increment_version_code(
      gradle_file_path: "apps/mobile/android/app/build.gradle"
    )
  end

  desc "Increment version name"
  lane :bump_version_name do |options|
    increment_version_name(
      gradle_file_path: "apps/mobile/android/app/build.gradle",
      bump_type: options[:bump_type] || "patch"
    )
  end
end

# ============================================================================
# Helper Functions
# ============================================================================

# Check if running in CI environment
def is_ci
  ENV['CI'] == 'true' || ENV['GITHUB_ACTIONS'] == 'true'
end
